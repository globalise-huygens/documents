{% extends "base.html" %} {% block title %}{{ inventory.inventory_number }} -
GLOBALISE Documents{% endblock %}

{% block extra_head %}
<link href="https://unpkg.com/vis-timeline@7.7.3/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
<script src="https://unpkg.com/vis-timeline@7.7.3/standalone/umd/vis-timeline-graph2d.min.js"></script>
<style>
  #timeline-container {
    width: 100%;
    height: 400px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  .vis-item {
    border-radius: 4px;
    border-width: 2px;
  }
  .vis-item.vis-selected {
    border-color: #333;
    background-color: #FFE082;
  }
  
  .page-info-container {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    font-size: 0.85em;
  }
  
  .page-info-column {
    flex: 1;
    padding: 0.5rem;
    background: #f9f9f9;
    border-radius: 4px;
    border-left: 3px solid transparent;
  }
  
  .page-info-column.single {
    flex: none;
    width: 100%;
  }
  
  .page-info-column.in-document {
    border-left-color: #4CAF50;
  }
  
  .page-info-column.not-in-document {
    border-left-color: #FF9800;
  }
  
  .page-info-header {
    font-weight: 600;
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .document-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
  }
  
  .document-indicator.in-document {
    background-color: #4CAF50;
  }
  
  .document-indicator.not-in-document {
    background-color: #FF9800;
  }
  
  .page-features {
    color: #666;
    font-style: italic;
    font-size: 0.9em;
  }
</style>
{% endblock %}

{% block content %}
<h1>Inventory: {{ inventory.inventory_number }}</h1>

<div class="card">
  <h2>Inventory Details</h2>
  <div class="info-row">
    <strong>Inventory Number:</strong>
    <span>{{ inventory.inventory_number }}</span>
  </div>
  <div class="info-row">
    <strong>NA Identifier:</strong>
    <span
      >{{ inventory.na_identifier if inventory.na_identifier else 'N/A' }}</span
    >
  </div>
  <div class="info-row">
    <strong>Date Range:</strong>
    <span>
      {% if inventory.date_start and inventory.date_end %} {{
      inventory.date_start }} - {{ inventory.date_end }} {% elif
      inventory.date_start %} From {{ inventory.date_start }} {% else %} Unknown
      {% endif %}
    </span>
  </div>
  <div class="info-row">
    <strong>Handle:</strong>
    <span>
      {% if inventory.handle %}
      <a href="{{ inventory.handle }}" target="_blank"
        >{{ inventory.handle }}</a
      >
      {% else %} N/A {% endif %}
    </span>
  </div>

  {% if inventory.titles %}
  <div class="info-row">
    <strong>Titles:</strong>
    <div>
      {% for title in inventory.titles %}
      <p>{{ title.title }}</p>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>

{% if series_paths %}
<div class="card">
  <h2>Series Membership</h2>
  <div class="series-hierarchy">
    {% for path in series_paths %}
      {% if path %}
        <ul>
          {% for node in path %}
            <li>
              {{ node.title }}
              {% if not loop.last %}
                <ul>
              {% endif %}
          {% endfor %}
          {% for node in path %}
            {% if not loop.first %}
                </ul>
              </li>
            {% endif %}
          {% endfor %}
            </li>
        </ul>
      {% endif %}
    {% endfor %}
  </div>
</div>
{% endif %}

<div class="card">
  <h2>Statistics</h2>
  <div class="info-row">
    <strong>Documents:</strong>
    <span>{{ documents|length }}</span>
  </div>
  <div class="info-row">
    <strong>Scans:</strong>
    <span>{{ scan_count }}</span>
  </div>
  <div class="info-row">
    <strong>Pages:</strong>
    <span>{{ page_count }}</span>
  </div>
</div>

{% if timeline_data and timeline_data.items %}
<div class="card">
  <h2>Document Identification Timeline</h2>
  <p>
    This visualization shows how different identification methods detected documents across <b>{{ timeline_data.total_pages - 1 }}</b> sequential pages in this inventory.
    Each row represents a different identification method, and each bar represents a document.
  </p>
  <div id="timeline-container"></div>
</div>

<script>
  // Timeline data from Flask
  var timelineData = {{ timeline_data | tojson | safe }};
  
  // Create a DataSet for groups and items
  var groups = new vis.DataSet(timelineData.groups);
  var items = new vis.DataSet(timelineData.items);
  
  // Configuration for the Timeline
  var options = {
    width: '100%',
    height: '400px',
    stack: false,
    start: 1,  // Start at page 1
    end: timelineData.total_pages,
    min: 1,  // Minimum is page 1
    max: timelineData.total_pages,
    zoomMin: 10,
    zoomMax: timelineData.total_pages * 2,
    type: 'range',
    orientation: 'top',
    selectable: true,
    multiselect: false,
    showCurrentTime: false,    
    xss: {
      disabled: false,
      filterOptions: {
        whiteList: {br: []},
      }
    },
    tooltip: {
      followMouse: true,
      overflowMethod: 'cap'
    },
    timeAxis: {scale: 'millisecond', step: 1},
    showMajorLabels: false,
  };
  
  // Create the Timeline
  var container = document.getElementById('timeline-container');
  var timeline = new vis.Timeline(container, items, groups, options);
  
  // Custom formatting for page numbers (already 1-based now)
  setTimeout(function() {
    var labels = container.querySelectorAll('.vis-text.vis-minor');
    labels.forEach(function(label) {
      var value = parseInt(label.textContent);
      if (!isNaN(value)) {
        label.textContent = 'Page ' + value;
      }
    });
  }, 100);
  
  // Handle item selection to navigate to document
  timeline.on('select', function(properties) {
    if (properties.items.length > 0) {
      var documentId = properties.items[0];
      window.location.href = '/document/' + documentId;
    }
  });
</script>
{% endif %}

{% if documents %}
<div class="card">
  <h2>Documents ({{ documents|length }})</h2>
  <table>
    <thead>
      <tr>
        <th>Title</th>
        <th>Date</th>
        <th>Pages</th>
        <th>Start Scan</th>
        <th>End Scan</th>
        <th>Method</th>
      </tr>
    </thead>
    <tbody>
      {% for doc in documents %}
      <tr>
        <td>
          <a href="/document/{{ doc.id }}"
            >{{ doc.title if doc.title else 'Untitled' }}</a
          >
        </td>
        <td>{{ doc|date_range }}</td>
        <td>{{ doc.number_of_pages }}</td>
        <td>
          {% if doc.first_scan_filename %}
          <a href="/scan/{{ doc.first_scan_filename }}">{{ doc.first_scan_filename }}</a>
          {% else %}
          N/A
          {% endif %}
        </td>
        <td>
          {% if doc.last_scan_filename %}
          <a href="/scan/{{ doc.last_scan_filename }}">{{ doc.last_scan_filename }}</a>
          {% else %}
          N/A
          {% endif %}
        </td>
        <td>{{ doc.method.name if doc.method else 'N/A' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %} {% if scans %}
<div class="card">
  <h2>Scans Preview (showing {{ scans|length }} of {{ scan_count }})</h2>
  {% if scan_count > 50 %}
  <p class="alert alert-info">
    Showing first 50 scans.
    <a href="/scans?inventory_id={{ inventory.id }}">View all scans</a>
  </p>
  {% endif %}
  <div class="image-grid">
    {% for scan in scans %}
    <div class="image-item">
      <a href="/scan/{{ scan.filename }}">
        <img
          src="{{ scan.get_thumbnail_url() }}"
          alt="{{ scan.filename }}"
          loading="lazy"
        />
      </a>
      <p><small>{{ scan.filename }}</small></p>
      
      {% if scan.pages_info %}
      <div class="page-info-container">
        {% for page_info in scan.pages_info %}
        <div class="page-info-column {% if scan.pages_info|length == 1 %}single{% endif %} {% if page_info.is_in_document %}in-document{% else %}not-in-document{% endif %}">
          <div class="page-info-header">
            <span class="document-indicator {% if page_info.is_in_document %}in-document{% else %}not-in-document{% endif %}"></span>
            <a href="/page/{{ page_info.page.id }}" style="color: inherit; text-decoration: none;">
              {{ page_info.recto_verso if page_info.recto_verso else 'Page' }}
            </a>
          </div>
          <div class="page-features">{{ page_info.features }}</div>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% if scan_count > 50 %}
  <p style="text-align: center; margin-top: 1rem">
    <a href="/scans?inventory_id={{ inventory.id }}"
      >View all {{ scan_count }} scans</a
    >
  </p>
  {% endif %}
</div>
{% endif %} {% endblock %}
